#!/usr/bin/env bash

set -euo pipefail

# This is used for the Hang at the end, for disabling it.
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")

SSH_DIR="$HOME/.ssh"
KEY_FILE="$SSH_DIR/id_ed25519_github"
PUB_KEY_FILE="$KEY_FILE.pub"

echo "ℹ️  Running preflight checks..."

# Ensure $HOME exists
if [ -z "$HOME" ]; then
    echo "❌ HOME variable not set!";
    exit 1;
fi

# Check required commands
for cmd in git ssh ssh-keygen ssh-add; do
    command -v "$cmd" >/dev/null || { echo "❌ $cmd is required but not installed." >&2; exit 1; }
    echo "✅ $cmd found"
done

# Ensure .ssh directory exists
mkdir -p "$SSH_DIR"
chmod 700 "$SSH_DIR"
echo "✅ .ssh directory exists with proper permissions"

# Generate SSH key if missing
if [[ ! -f "$KEY_FILE" ]]; then
    echo "ℹ️  No SSH key found. Generating id_ed25519_github..."
    read -rp "Enter a comment for the SSH key (optional, press ENTER to skip): " KEY_COMMENT
    ssh-keygen -t ed25519 -f "$KEY_FILE" -N "" -C "$KEY_COMMENT"
fi

# Set correct permissions
chmod 600 "$KEY_FILE"
chmod 644 "$PUB_KEY_FILE"
echo "✅ SSH key files exist with correct permissions"

# Start temporary ssh-agent for simulation
echo "ℹ️  Starting temporary ssh-agent for testing..."
eval "$(ssh-agent -s)" >/dev/null
echo "✅ Temporary ssh-agent running"

# Add key to temporary agent
echo "ℹ️  Adding key to temporary ssh-agent..."
ssh-add "$KEY_FILE" || { echo "❌ Failed to add SSH key to temporary agent"; exit 1; }
echo "✅ SSH key loaded into temporary agent"

# Print the public key for GitHub
echo
echo "───────────────────── ℹ️  PUBLIC KEY ℹ️  ─────────────────────"
echo
cat "$PUB_KEY_FILE"
echo
echo "───────────────────── ℹ️  PUBLIC KEY ℹ️  ─────────────────────"
echo

# Prompt user to add the key to GitHub
echo "1. Triple-click the key above and copy it. DO NOT HIT CTRL + C"
echo "2. Add it to GitHub: https://github.com/settings/ssh/new"
echo "   - Give it a Title"
echo "   - Leave 'Key Type' as 'Authentication Key'"
echo "   - Paste the key"
echo "3. After adding, press ENTER to continue..."
read -rp ""

# Test SSH connection in this temporary simulation
echo "ℹ️  Testing GitHub SSH connection with temporary agent..."
echo
SSH_TEST_OUTPUT="$(ssh -T git@github.com 2>&1 || true)"

if echo "$SSH_TEST_OUTPUT" | grep -Eq "successfully authenticated|Hi "; then
    echo "✅ Simulation: GitHub SSH authentication succeeded"
else
    echo "$SSH_TEST_OUTPUT"
    echo "Simulation: Authentication may fail until key is added and agent is running in your shell"
fi

echo
echo "✅ Setup complete"
echo
echo "ℹ️  You can now run my other scripts for a full local git workflow setup:"
echo "     bash <(wget -qO- https://nikoboinftb.github.io/shell/git/setup/automation)"
echo "       (Completely optional)"
echo

# Important steps box
echo "┌───────────────────── ⚠️  IMPORTANT ⚠️  ─────────────────────┐"
echo "│                                                           │"
echo "│   Due to limitations, these steps must be run manually:   │"
echo "│                                                           │"
echo "│     1. Start an ssh-agent:                                │"
echo "│          eval \"\$(ssh-agent -s)\"                           │" # What the fuck is this?
echo "│                                                           │"
echo "│     2. Add the key:                                       │"
echo "│          ssh-add ~/.ssh/id_ed25519_github                 │"
echo "│                                                           │"
echo "│     3. Test GitHub connection (optional):                 │"
echo "│          ssh -T git@github.com                            │"
echo "│                                                           │"
echo "└───────────────────── ⚠️  IMPORTANT ⚠️  ─────────────────────┘"

# Hang

KEEP_OPEN=false

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging (local only): " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$SCRIPT_PATH"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        echo
        for i in {5..1}; do
            echo -n "Exiting in $i..."
            sleep 1
            echo -ne "\r"
        done
        echo "Exiting now.        "
    fi
fi
