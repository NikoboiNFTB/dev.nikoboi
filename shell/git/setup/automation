#!/usr/bin/env bash

set -e

# This is used for the Hang at the end, for disabling it.
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")

# Ensure $HOME exists
if [ -z "$HOME" ]; then
    echo "❌ HOME variable not set!"
    exit 1
fi

# Get username from first argument or prompt
AUTHOR="$1"

if [ -z "$AUTHOR" ]; then
    read -rp "Enter the GitHub username of the target user: " AUTHOR
fi

AUTHOR=${AUTHOR// /}  # remove spaces just in case

echo

if [ -z "$AUTHOR" ]; then
    echo "❌ No username provided. Exiting."
    exit 1
fi

# Define directories
ROOT_DIR="$HOME/GitHub"
AUTHOR_DIR="$ROOT_DIR/$AUTHOR"

# Check if author's GitHub folder exists
if [ ! -d "$AUTHOR_DIR" ]; then
    echo "❌ The folder '$AUTHOR_DIR' does not exist."
    echo "ℹ️  Repos for '$AUTHOR' must be in '$AUTHOR_DIR'"
    exit 1
fi

cd "$AUTHOR_DIR"

# Ensure jq is installed
if ! command -v jq &> /dev/null; then
    echo "❌ Error: jq is required but not installed."
    exit 1
fi

# Clone GitHub-Tools repo
TOOLS_DIR="$ROOT_DIR/NikoboiNFTB/GitHub-Tools"
mkdir -p "$(dirname "$TOOLS_DIR")"

if [ -d "$TOOLS_DIR/.git" ]; then
    echo "ℹ️  Updating GitHub-Tools..."
    cd "$TOOLS_DIR" && git pull --quiet || echo "❌ Pulling GitHub-Tools failed"
else
    echo "ℹ️  Cloning GitHub-Tools..."
    git clone --quiet https://github.com/NikoboiNFTB/GitHub-Tools.git "$TOOLS_DIR" || echo "❌ Cloning GitHub-Tools failed"
fi

echo

cd "$AUTHOR_DIR"

# Copy workflow scripts from GitHub-Tools to correct locations
echo "ℹ️  Copying files..."

mkdir -p "$AUTHOR_DIR/auto"

# repo/ → $AUTHOR_DIR
for file in "$TOOLS_DIR/shell/git/repo/"*; do
    cp "$file" "$AUTHOR_DIR/auto/" || echo "❌ Failed to copy $file"
    chmod +x "$AUTHOR_DIR/auto/$(basename "$file")"
done

# bulk/ → $AUTHOR_DIR
for file in "$TOOLS_DIR/shell/git/bulk/"*; do
    cp "$file" "$AUTHOR_DIR/" || echo "❌ Failed to copy $file"
    chmod +x "$AUTHOR_DIR/$(basename "$file")"
done

# clone/ → $ROOT_DIR
for file in "$TOOLS_DIR/shell/git/clone/"*; do
    cp "$file" "$ROOT_DIR/" || echo "❌ Failed to copy $file"
    chmod +x "$ROOT_DIR/$(basename "$file")"
done

# ssh/ → $AUTHOR_DIR
for file in "$TOOLS_DIR/shell/git/ssh/"*; do
    cp "$file" "$AUTHOR_DIR/" || echo "❌ Failed to copy $file"
    chmod +x "$AUTHOR_DIR/$(basename "$file")"
done

# mass/ → $ROOT_DIR
for file in "$TOOLS_DIR/shell/git/mass/"*; do
    cp "$file" "$ROOT_DIR/" || echo "❌ Failed to copy $file"
    chmod +x "$ROOT_DIR/$(basename "$file")"
done

echo "✅ Files copied!"

# Add auto/ to */.git/info/exclude
FILES=(/auto/pull /auto/push /auto/status)

for d in */; do
    [ "$d" = "auto/" ] && continue
    repo_git="$d/.git/info/exclude"
    if [ -f "$repo_git" ]; then
        for FILE_NAME in "${FILES[@]}"; do
            if ! grep -qxF "$FILE_NAME" "$repo_git"; then
                echo "$FILE_NAME" >> "$repo_git"
            fi
        done
    fi
    cp -r auto "$d" 2>/dev/null || echo "❌ Failed to copy auto to $d"
done

rm -rf auto 2>/dev/null

# Hide SSH scripts prompt
echo
read -rp "Hide SSH scripts? (Y/n): " hide_ssh

if [[ "$hide_ssh" =~ ^[nN]$ ]]; then
    rm -f "$AUTHOR_DIR/.disable-ssh" "$AUTHOR_DIR/.enable-ssh"
    echo "✅ SSH scripts not hidden."
else
    mv "$AUTHOR_DIR/disable-ssh" "$AUTHOR_DIR/.disable-ssh" 2>/dev/null || true
    mv "$AUTHOR_DIR/enable-ssh" "$AUTHOR_DIR/.enable-ssh" 2>/dev/null || true
    echo "✅ SSH scripts hidden."
    echo "ℹ️  They can be found at:"
    echo "    $AUTHOR_DIR/.disable-ssh"
    echo "    $AUTHOR_DIR/.enable-ssh"
fi

# Hang

KEEP_OPEN=true

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging (local only): " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$SCRIPT_PATH"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        echo
        for i in {5..1}; do
            echo -n "Exiting in $i..."
            sleep 1
            echo -ne "\r"
        done
        echo "Exiting now.        "
    fi
fi
