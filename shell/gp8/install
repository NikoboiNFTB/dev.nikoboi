#!/usr/bin/env bash

set -e

# This is used for the Hang at the end, for disabling it.
SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")

# Definitions
NIKOB_DIR="$HOME/GitHub/NikoboiNFTB"
REPO_DIR="$NIKOB_DIR/Guitar-Pro-On-Linux"

# Check that $HOME is setup properly.
if [ -z "$HOME" ]; then
    echo "HOME variable not set!"
    exit 1
fi

REQUIRED_CMDS=(
  bash
  wget
  wine
  winetricks
  sed
  cp
  mkdir
  git
)

MISSING=()

for cmd in "${REQUIRED_CMDS[@]}"; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    MISSING+=("$cmd")
  fi
done

if [ "${#MISSING[@]}" -ne 0 ]; then
  echo "❌ Missing required applications:"
  for cmd in "${MISSING[@]}"; do
    echo "  - $cmd"
  done
  echo

  PKGS="${MISSING[*]}"

  echo "Install the missing dependencies using your package manager:"
  echo
  echo "Debian / Ubuntu:"
  echo "  sudo apt update && sudo apt install -y $PKGS"
  echo
  echo "Arch / Manjaro:"
  echo "  sudo pacman -S $PKGS"
  echo
  echo "Fedora:"
  echo "  sudo dnf install $PKGS"
  echo
  echo "openSUSE:"
  echo "  sudo zypper install $PKGS"
  echo
  echo "After installing them, re-run this script."
  exit 1
fi

echo "✅ All required applications are installed."

# Make and CD to my GitHub directory.
mkdir -p "$NIKOB_DIR"
cd "$NIKOB_DIR"

# Clone the fork if it doesn't exist yet
if [ ! -d "$REPO_DIR/.git" ]; then
    echo "Cloning repository..."
    git clone https://github.com/NikoboiNFTB/Guitar-Pro-On-Linux "$REPO_DIR"
else
    echo "Repository already exists, updating..."
    cd "$REPO_DIR"
    git pull
fi

# Move into repo and run build
cd "$REPO_DIR"
bash build

echo
echo "Installation complete!"
echo "You can launch Guitar Pro 8 via the Desktop icon or:"
echo "$HOME/Applications/Windows/Guitar-Pro-8/startup"
echo "WARNING: Cinnamon (and likely other DE) app menu entry does **not** work as of $(date)."

# Hang

KEEP_OPEN=true

if [ "$KEEP_OPEN" = true ]; then
    echo
    read -p "Press 'Enter' to exit / Type 'disable' to disable hanging (local only): " response
    if [ "$response" = "disable" ]; then
        sed -i 's/^KEEP_OPEN=true/KEEP_OPEN=false/' "$SCRIPT_PATH"
        echo
        echo "KEEP_OPEN set to false"
        echo "Change 'KEEP_OPEN=true' to enable"
        echo
        for i in {5..1}; do
            echo -n "Exiting in $i..."
            sleep 1
            echo -ne "\r"
        done
        echo "Exiting now.        "
    fi
fi
